<!DOCTYPE html>
<html lang="zh">

<head>
    <!-- <script src="js/init.js"></script> -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IT LOVE 提问</title>
    <!-- LOADING STYLESHEETS -->
    <link href="css/ask.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link href="css/newstyle.css" rel="stylesheet">
    <!--     <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"> -->
    <script src="https://www.gstatic.com/firebasejs/5.0.3/firebase.js"></script>
    <script>
    var config = {
        apiKey: "AIzaSyBZUz6V1Mkmwxpe781P8X6ZC7fPTUyiBIg",
        authDomain: "it-love1.firebaseapp.com",
        databaseURL: "https://it-love1.firebaseio.com",
        projectId: "it-love1",
        storageBucket: "it-love1.appspot.com",
        messagingSenderId: "782043275132"
    };
    firebase.initializeApp(config);
    </script>
    <script>
    /**
     * init firestone
     */
    // Initialize Cloud Firestore through Firebase
    function initApp() {
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                document.getElementById('signintop').textContent = '';
                var tag = document.createElement("i");
                tag.setAttribute('class', 'fa fa-key');
                document.getElementById('signintop').appendChild(tag);
                var text = document.createElement("div");
                text.setAttribute('style', 'display: inline;');
                text.textContent = '注销';
                document.getElementById('signintop').appendChild(text);

                document.getElementById('signuptop').style.display = "none";
                var email = "" + user.email;
                var db = firebase.firestore();
                var ref = db.collection("user").doc(email);
                ref.get().then(function(doc) {
                    if (doc.exists) {
                        if (typeof doc.data == 'function') {
                            var dic = doc.data();
                            document.getElementById('welcome').textContent = '欢迎 ' + dic["Name"];
                        }
                    } else{
                        console.log("No such document!");
                        document.getElementById('welcome').textContent = '欢迎 xxx （您还未命名）';
                    }});
            } else {
                window.open('登录.html', "_self");
                document.getElementById('system').style.display = "none";
            }
        });
        document.getElementById('signintop').addEventListener('click', toggleSignIn, false);
    }

    function toggleSignIn() {
        if (firebase.auth().currentUser) {
            // [START signout]
            firebase.auth().signOut();
            window.open('登录.html', "_self");
            // [END signout]
        } else {
            window.open('登录.html', "_self");
        }
    }

    window.onload = function() {
        initApp();
    };
    </script>
</head>

<body>
    <div class="toppest">
        <div class="login-box">
            <div id="signintop">
                <i class="fa fa-key"></i> 登陆</div>
        </div>
        <div class="login-box" id="signuptop">
            <a href="email-password.html">
                <i class="fa fa-pencil"></i> 注册</a>
        </div>
        <div class="login-box" id="system">
            <a href="系统消息.html">
                <i class="fa fa-bell"></i> 系统消息</a>
        </div>
        <div class="login-box nohover">
            <div id="welcome">
            </div>
        </div>
    </div>
    <!-- TOP NAVIGATION -->
    <div class="topnav-outline">
        <ul class="topnav">
            <li>
                <a href="index.html">
                    <i class="fa fa-home"></i> 首页</a>
            </li>
            <li>
                <a href="提问.html">
                    <i class="fa fa-book"></i> 提问</a>
            </li>
            <li>
                <a href="回答.html">
                    <i class="fa fa-file-text-o"></i> 回答</a>
            </li>
            <li class="icon">
                <a href="javascript:void(0);" onclick="myFunction()">&#9776;</a>
            </li>
        </ul>
    </div>
    <!-- END TOP NAVIGATION -->
    <h1 class="pageheader text-center">提问</h1>
    <!-- MAIN SECTION -->
    <div class="text-center">
        <div class="bar">&nbsp;</div>
        <form>
            <textarea rows="5" name="text" placeholder="问题描述" class="desc"></textarea>
            <!-- Container for the demo -->
            <div class="drop">
                <!--       <input type='file' onchange="readURL(this);" />
                           <img id="blah" src=# alt="your image" /> -->
                <h4 style="margin-top: 0px;">上传聊天记录</h4>
                <button type="button" onclick="addAnotherFile()" class="btn">添加聊天记录</button>
                <div id="messagesDiv">
                    <input type="file" id="files" name="files[]" multiple />
                </div>
                <!--   <input type="file" id="file" name="file"/> -->
            </div>
            <input type="checkbox" value="" id="defaultCheck1">
            <label for="defaultCheck1">
                发布到公共社区
            </label>
        </form>
        <button onclick="myButtonFunction()" class="btn">提出解决方案</button>
    </div>
    <!-- END MAIN SECTION -->
    <!-- LOADING MAIN JAVASCRIPT -->
    <script src="js/jquery-2.2.4.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src='https://cdn.rawgit.com/VPenkov/okayNav/master/app/js/jquery.okayNav.js'></script>
    <script>
    var auth = firebase.auth();
    var storageRef = firebase.storage().ref();

    function handleFileSelect(evt) {
        console.log("test");
        evt.stopPropagation();
        evt.preventDefault();
        var file = evt.target.files[0];
        var metadata = {
            'contentType': file.type
        };
        // Push to child path.
        // [START oncomplete]
        // console.log(user.uid);
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                var email = "" + user.email;
                storageRef.child('image/' + file.name).put(file, metadata).then(function(snapshot) {
                    console.log('Uploaded', snapshot.totalBytes, 'bytes.');
                    console.log('File metadata:', snapshot.metadata);
                    // Let's get a download URL for the file.
                    snapshot.ref.getDownloadURL().then(function(url) {
                        console.log('File available at', url);
                        var db = firebase.firestore();
                        var ref = db.collection("user");
                        ref.doc(email).collection("Questions").doc().set({ image: "" + url });
                    });
                }).catch(function(error) {
                    // [START onfailure]
                    console.error('Upload failed:', error);
                    // [END onfailure]
                });
            } else {
                // No user is signed in.
            }
        });
    }
    // storageRef.child('image/' + file.name).put(file, metadata).then(function(snapshot) {
    //   console.log("test1");
    //   console.log('Uploaded', snapshot.totalBytes, 'bytes.');
    //   console.log('File metadata:', snapshot.metadata);
    //   // Let's get a download URL for the file.
    //   snapshot.ref.getDownloadURL().then(function(url) {
    //     console.log('File available at', url);
    //     // [START_EXCLUDE]
    //     document.getElementById('linkbox').innerHTML = '<a href="' +  url + '">Click For File</a>';
    //     // [END_EXCLUDE]
    //   });
    // }).catch(function(error) {
    //   // [START onfailure]
    //   console.error('Upload failed:', error);
    //   // [END onfailure]
    // });
    // // [END oncomplete]

    //     window.onload = function() {
    //       document.getElementById('file').addEventListener('change', handleFileSelect, false);
    //       document.getElementById('file').disabled = false;
    //     auth.onAuthStateChanged(function(user) {
    //       if (user) {
    //         console.log('Anonymous user signed-in.', user);
    //         document.getElementById('file').disabled = false;
    //       } else {
    //         console.log('There was no anonymous session. Creating a new anonymous user.');
    //         // Sign the user in anonymously since accessing Storage requires the user to be authorized.
    //         auth.signInAnonymously().catch(function(error) {
    //           if (error.code === 'auth/operation-not-allowed') {
    //             window.alert('Anonymous Sign-in failed. Please make sure that you have enabled anonymous ' +
    //                 'sign-in on your Firebase project.');
    //           }
    //         });
    //       }
    //     });
    // }
    function addAnotherFile() {
        // <button id="clickMe" onclick="addAnotherFile()">添加聊天记录</button>
        // <input type="file" id="file" name="file"/>
        //<input type="file" id="files" name="files[]" multiple />
        var div = document.createElement('div');
        // var btn = document.createElement("button");
        var i = document.createElement("input");
        // btn.setAttribute('onclick',"addAnotherFile()");
        // btn.text = "test";
        i.setAttribute('type', "file");
        i.setAttribute('name', "file");
        i.setAttribute('id', "file");
        div.appendChild(i);
        // div.appendChild(btn);
        document.getElementById("messagesDiv").appendChild(div);
        console.log("Test");
    }
    // function initApp(){
    //     document.getElementById("clickMe").addEventListener('click', addAnotherFile, false);
    // }
    // window.onload = function() {
    //     initApp();
    // };
    </script>
</body>

</html>